"use strict";function DataHandler(e,t,a,s){this.hooks=s||{},this.defaults=t||{dataview:"default_view",time:"time"},this.settings=e||{},this.info=e&&e.metadata.info||{},this.features={},this.variables={},this.variable_codes={},this.variable_info={},this.references={},this.entities={},this.meta={times:{},variables:{},ranges:{},overall:{range:[1/0,-1/0],value:[]}},this.loaded={},this.inited={},this.inited_summary={},this.summary_ready={},this.sets={},this.data_maps={},this.data_queue={},this.data_promise={},this.data_processed={},this.load_requests={},this.in_browser="undefined"==typeof module,this.data_ready=new Promise((e=>{this.all_data_ready=e})),a=a||{},"string"==typeof e.metadata.datasets&&(e.metadata.datasets=[e.metadata.datasets]),this.map_variables(),e.metadata.datasets.forEach((t=>{this.loaded[t]=t in a,this.data_processed[t]=new Promise((e=>{this.data_promise[t]=e})),this.in_browser&&(!this.settings.settings||this.settings.settings.partial_init)&&this.defaults.dataset&&t!==this.defaults.dataset||(this.loaded[t]?this.ingest_data(a[t],t):this.retrieve(t,e.metadata.info[t].site_file))}))}function quantile(e,t,a,s,i){const n=e*(t-1),r=n%1,o=1-r,m=a+Math.ceil(n),l=a+Math.floor(n);return i?s[l]*r+s[m]*o:s[l][1]*r+s[m][1]*o}function vector_summary(e,t){if("object"==typeof e){const s=Math.min(t[1]+1,e.length),i=[],n={first:e[0],min:1/0,mean:0,sum:0,max:-1/0,last:e[s-1]};var a=0;for(let r=Math.max(t[0],0);r<s;r++){const t=e[r];i.push(t),isNaN(t)||(a++,n.min>t&&(n.min=t),n.max<t&&(n.max=t),n.sum+=t)}return n.mean=a?n.sum/a:0,n}return{first:e,min:e,mean:e,max:e,last:e}}function passes_filter(e,t,a,s){const i={},n={};for(let r=a.filter_by.length;r--;){const o=a.filter_by[r],m=s[o].code;if(!(m in e.data))return!1;const l=e.group in s[o].info?s[o].info[e.group].time_range:s[o].time_range[e.group];if(!l)return!1;n[o]=l[0],i[o]=vector_summary(e.data[m],[t[0]-l[0],Math.max(t[1]-l[0],t[1]-l[1])])}for(let t=a.conditions.length;t--;){const r=a.conditions[t];if(!(r.time_component?r.check(e.data[s[r.name].code],n[r.name]||0):r.check(i[r.name])))return!1}return!0}function passes_feature_filter(e,t,a){const s=e[t];for(var i=a.length;i--;)if("-1"!==a[i].value){if("id"===a[i].name){var n=!1;return a[i].value.forEach((t=>{if(!n){const a=t in e&&e[t].group;(a&&a in s.features?t===s.features[a]:t.length<s.features.id.length?t===s.features.id.substring(0,t.length):t===s.features.id)&&(n=!0)}})),n}if(!a[i].check(s.features[a[i].name]))return!1}return!0}const patterns={seps:/[\s._-]/g,comma:/,/,word_start:/\b(\w)/g,single_operator:/([<>!])([^=])/,greater:/%3E$/,less:/%3C$/,operator_start:/[<>!]$/,component:/^(.+)\[(.+)\]/,number:/^[0-9.+-]+$/},export_defaults={file_format:"csv",table_format:"mixed",features:{ID:"id",Name:"name"},feature_conditions:[],variables:{filter_by:[],conditions:[]}},export_options={file_format:["csv","tsv"],table_format:["tall","mixed","wide"],filter_components:["first","min","mean","sum","max","last"]},row_writers={tall:function(e,t,a,s,i){if(e.group in this.meta.times){const r=[],o=this.meta.times[e.group].value;var n="";return Object.keys(a).forEach((t=>{n+='"'+e.features[a[t]]+'"'+i})),s.forEach((a=>{const s=e.variables[a].code;if(s in e.data){const l=this.meta.variables[e.group][a].time_range;var m="";const h=t[1]+1;for(let r=t[0];r<h;r++)if(r>=l[0]&&r<=l[1]){const t="number"==typeof e.data[s]?e.data[s]:e.data[s][r-l[0]];isNaN(t)||(m+=(m?"\n":"")+n+o[r]+i+'"'+a+'"'+i+t)}m&&r.push(m)}})),r.join("\n")}},mixed:function(e,t,a,s,i){if(e.group in this.meta.times){const o=[],m=this.meta.times[e.group].value;var n="";Object.keys(a).forEach((t=>{n+='"'+e.features[a[t]]+'"'+i}));const l=t[1]+1;for(let a=t[0];a<l;a++){var r=n+m[a];s.forEach((t=>{const s=e.variables[t].code;if(s in e.data){const n=this.meta.variables[e.group][t].time_range,o=a<n[0]||a>n[1]?NaN:n[0]===n[1]?a===n[0]?e.data[s]:NaN:e.data[s][a-n[0]];r+=i+(isNaN(o)?"NA":o)}else r+=i+"NA"})),o.push(r)}return o.join("\n")}},wide:function(e,t,a,s,i){if(e.group in this.meta.times){var n="";return Object.keys(a).forEach((t=>{n+=(n?i:"")+'"'+e.features[a[t]]+'"'})),s.forEach((a=>{const s=e.variables[a].code,r=this.meta.ranges[a],o=this.meta.variables[e.group][a].time_range,m=t[1]+1;for(let a=t[0];a<m;a++)if(a>=r[0]&&a<=r[1])if(s in e.data){const t=a<o[0]||a>o[1]?NaN:o[0]===o[1]?a===o[0]?e.data[s]:NaN:a<o[0]||a>o[1]?NaN:e.data[s][a-o[0]];n+=i+(isNaN(t)?"NA":t)}else n+=i+"NA"})),n}}},group_checks={"!":function(e){return this!==e},"=":function(e){return this===e},includes:function(e){return-1!==this.indexOf(e)},excludes:function(e){return-1===this.indexOf(e)}};DataHandler.prototype={constructor:DataHandler,checks:{"!":function(e){return!e||-1==e},"":function(e){return!!e&&-1!=e},"=":function(e,t){return e===t},"!=":function(e,t){return e!=t},">":function(e,t){return e>t},"<":function(e,t){return e<t},">=":function(e,t){return e>=t},"<=":function(e,t){return e<=t},equals:function(e,t){return!e||-1==e||e===t},includes:function(e,t){return!e||!e.length||-1!==e.indexOf(t)},excludes:function(e,t){return!e||!e.length||-1===e.indexOf(t)},sort_a1:function(e,t){return isNaN(e[1])?isNaN(t[1])?0:-1:isNaN(t[1])?1:e[1]-t[1]}},export_checks:{file_format:function(e){return-1===export_options.file_format.indexOf(e)},table_format:function(e){return-1===export_options.table_format.indexOf(e)},include:function(e,t){for(let a=e.length;a--;)if(!(e[a]in t))return e[a];return""}},retrievers:{single:function(e,t){return t<0?NaN:this.variables[e].is_time?t<this.time.value.length?this.time.value[t]:NaN:(e=this.variables[e].code,0===t&&e in this.data?this.data[e]:NaN)},multi:function(e,t){return t<0?NaN:this.variables[e].is_time?this.time.value[t]:(e=this.variables[e].code)in this.data?"object"==typeof this.data[e]?t<this.data[e].length?this.data[e][t]:NaN:0===t?this.data[e]:NaN:NaN},vector:function(e){if(this.variables[e.variable].is_time)return e.entity.time.value;{const t=this.variables[e.variable].code;return t in e.entity.data?"object"==typeof e.entity.data[t]?e.entity.data[t]:[e.entity.data[t]]:[NaN]}},row_time:function(e,t,a){const s=this.i-(a.offset-this.o);return e&&s>=0&&s<e.length?"number"==typeof e[s]?this.format_value(e[s],a.int):e[s]:NaN}},format_value:function(e,t){if(null===e||isNaN(e))return"unknown";if(t)return e;if(this.settings.settings.digits>0){const t=Math.pow(10,this.settings.settings.digits),a=(Math.round(e*t)/t+"").split(".");return a[0]+("."+(1===a.length?"":a[1])+"0000000000").substring(0,this.settings.settings.digits+1)}return Math.round(e)},format_label:function(e){return"string"!=typeof e?"":e in this.variables&&this.variables[e].meta&&this.variables[e].meta.short_name?this.variables[e].meta.short_name:e.replace(patterns.seps," ").replace(patterns.word_start,(function(e){return e.toUpperCase()}))},ingest_data:function(e,t){if(this.sets[t]=e,this.loaded[t]=!0,t in this.info||(this.info[t]={schema:{fields:[]},ids:[]}),"_meta"in e&&(this.meta.times[t]=e._meta.time,"object"!=typeof this.meta.times[t].value&&(this.meta.times[t].value=[this.meta.times[t].value]),this.meta.times[t].n=this.meta.times[t].value.length,this.meta.times[t].is_single=1===this.meta.times[t].n,this.meta.times[t].range=[this.meta.times[t].value[0],this.meta.times[t].value[this.meta.times[t].n-1]],e._meta.time.name in this.variables&&(this.meta.times[t].info=this.variables[this.meta.times[t].name],this.meta.times[t].info.is_time=!0),this.meta.times[t].range[0]<this.meta.overall.range[0]&&(this.meta.overall.range[0]=this.meta.times[t].range[0]),this.meta.times[t].range[1]>this.meta.overall.range[1]&&(this.meta.overall.range[1]=this.meta.times[t].range[1]),this.meta.times[t].value.forEach((e=>{-1===this.meta.overall.value.indexOf(e)&&this.meta.overall.value.push(e)})),this.meta.overall.value.sort(),this.meta.variables[t]=e._meta.variables||{},Object.keys(this.meta.variables[t]).forEach((e=>{e in this.variables||(this.variables[e]={datasets:[t],info:{},time_range:{},type:"unknown",meta:{full_name:e,measure:e.split(":")[1]||e,short_name:this.format_label(e),long_name:e,type:"unknown"}},this.variable_info[e]=this.variables[e].meta),this.variables[e].name=e,this.variables[e].code=this.meta.variables[t][e].code;const a=this.meta.variables[t][e].time_range;this.variables[e].time_range[t]=a,this.variable_codes[this.variables[e].code]=this.variables[e],-1!==a[0]&&(e in this.meta.ranges?(a[0]<this.meta.ranges[e][0]&&(this.meta.ranges[e][0]=a[0]),a[1]>this.meta.ranges[e][1]&&(this.meta.ranges[e][1]=a[1])):this.meta.ranges[e]=[a[0],a[1]])}))),this.in_browser&&this.settings.settings.partial_init&&(!this.defaults.dataset||t===this.defaults.dataset||site.data.inited.first))this.load_id_maps();else{for(const e in this.loaded)if(Object.prototype.hasOwnProperty.call(this.loaded,e)&&!this.loaded[e])return;this.load_id_maps()}},retrieve:async function(e,t){if(!this.load_requests[e]){this.load_requests[e]=t,this.inited[e]=!1;const a=new window.XMLHttpRequest;a.onreadystatechange=()=>{if(4===a.readyState){if(200!==a.status)throw new Error("load_data failed: "+a.responseText);this.ingest_data(JSON.parse(a.responseText),e)}},a.open("GET",t,!0),a.send()}},ingest_map:function(e,t,a){this.data_maps[t].resource=e,this.data_maps[t].retrieved=!0,this.data_maps[t].queue.forEach((e=>{this.info[e].schema.fields.length>a&&(this.info[e].schema.fields[a].ids=this.data_maps[e]=e in this.data_maps[t].resource?this.data_maps[t].resource[e]:this.data_maps[t].resource,this.map_entities(e))})),this.hooks.data_load&&this.hooks.data_load()},load_id_maps:async function(){this.settings.metadata.datasets.forEach((e=>{var t=!1;this.info[e].ids.forEach(((a,s)=>{if("map"in a){t=!0;const i=a.map;if(i in this.data_maps)this.data_maps[i].retrieved?(this.info[e].schema.fields[s].ids=this.data_maps[e]=e in this.data_maps[i].resource?this.data_maps[i].resource[e]:this.data_maps[i].resource,this.map_entities(e)):-1===this.data_maps[i].queue.indexOf(e)&&this.data_maps[i].queue.push(e);else if("string"!=typeof i||a.map_content)a.map_content?(this.data_maps[i]={queue:[],resource:JSON.parse(a.map_content),retrieved:!0},this.info[e].schema.fields[s].ids=this.data_maps[e]=e in this.data_maps[i].resource?this.data_maps[i].resource[e]:this.data_maps[i].resource):this.data_maps[e]=i,this.map_entities(e);else if(this.data_maps[i]={queue:[e],resource:{},retrieved:!1},"undefined"!=typeof window){const e=new window.XMLHttpRequest;e.onreadystatechange=function(t,a){if(4===e.readyState){if(200!==e.status)throw new Error("load_id_maps failed: "+e.responseText);this.ingest_map(JSON.parse(e.responseText),t,a)}}.bind(this,i,s),e.open("GET",i,!0),e.send()}else require("https").get(a.map,(e=>{const t=[];e.on("data",(e=>{t.push(e)})),e.on("end",(()=>{this.ingest_map(JSON.parse(t.join("")),e.req.protocol+"//"+e.req.host+e.req.path,s)}))})).end()}})),t||(this.data_maps[e]={},this.map_entities(e))}))},init_summary:function(e,t){this.inited_summary[t+e]||(this.in_browser?Object.keys(site.dataviews):["default_view"]).forEach((a=>{const s=this.variables[e];a in s||(s[a]={order:{},selected_order:{},selected_summaries:{},summaries:{},state:{}}),t in s.time_range||(s.time_range[t]=[0,this.meta.times[t].n-1]);const i=s.time_range[t][2]=s.time_range[t][1]-s.time_range[t][0]+1,n=s[a],r=s.code;if(t in this.sets){var o;const n=this.sets[t],m=this.info[t].entity_count,l=!m||m>65535?Uint32Array:m>255?Uint16Array:Uint8Array;if("order"in s.info[t])o=s.info[t].order,Object.keys(n).forEach((t=>{t in this.entities||(this.entities[t]={}),a in this.entities[t]||(this.entities[t][a]={summary:{},rank:{},subset_rank:{}}),this.entities[t][a].rank[e]=new l(i),this.entities[t][a].subset_rank[e]=new l(i)}));else{s.info[t].order=o=[];for(let e=i;e--;)o.push([]);Object.keys(n).forEach((t=>{const s=n[t];if("_meta"!==t&&r in s){const n=s[r];if(1===i)"number"!=typeof n?(s[r]=NaN,o[0].push([t,NaN])):o[0].push([t,n]);else{for(let e=i;e--;)"number"!=typeof n[e]&&(n[e]=NaN),o[e].push([t,n[e]]);Object.freeze(n)}t in this.entities||(this.entities[t]={}),a in this.entities[t]||(this.entities[t][a]={summary:{},rank:{},subset_rank:{}});const m=this.entities[t][a];e in m.rank||(m.rank[e]=new l(i),m.subset_rank[e]=new l(i))}}))}o.forEach(((t,s)=>{t=o[s],Object.isFrozen(t)||(t.sort(this.checks.sort_a1),Object.freeze(t)),t.forEach(((t,i)=>{this.entities[t[0]][a].rank[e][s]=i}))}))}if(!(t in n.summaries)){if(n.order[t]=[],n.selected_order[t]=[],n.selected_summaries[t]={n:[],missing:[]},"string"===s.info[t].type){n.table={},Object.keys(s.levels_ids).forEach((e=>{n.table[e]=[];for(let t=i;t--;)n.table[e].push(0)})),n.summaries[t]={filled:!1,missing:[],n:[],mode:[],level_ids:s.levels_ids,levels:s.levels};for(let e=i;e--;)n.order[t].push([]),n.selected_order[t].push([]),n.summaries[t].missing.push(0),n.summaries[t].n.push(0),n.summaries[t].mode.push("")}else{n.summaries[t]={filled:!1,missing:[],n:[],sum:[],max:[],q3:[],mean:[],range:[],norm_median:[],break_median:[],lower_median_min:[],lower_median_range:[],upper_median_min:[],upper_median_range:[],norm_mean:[],break_mean:[],lower_mean_min:[],lower_mean_range:[],upper_mean_min:[],upper_mean_range:[],median:[],q1:[],min:[]};for(let e=i;e--;)n.order[t].push([]),n.selected_order[t].push([]),n.selected_summaries[t].n.push(0),n.selected_summaries[t].missing.push(0),n.summaries[t].missing.push(0),n.summaries[t].n.push(0),n.summaries[t].sum.push(0),n.summaries[t].max.push(-1/0),n.summaries[t].q3.push(0),n.summaries[t].mean.push(0),n.summaries[t].norm_median.push(0),n.summaries[t].break_median.push(-1),n.summaries[t].lower_median_min.push(-1),n.summaries[t].lower_median_range.push(-1),n.summaries[t].upper_median_min.push(-1),n.summaries[t].upper_median_range.push(-1),n.summaries[t].norm_mean.push(0),n.summaries[t].break_mean.push(-1),n.summaries[t].lower_mean_min.push(-1),n.summaries[t].lower_mean_range.push(-1),n.summaries[t].upper_mean_min.push(-1),n.summaries[t].upper_mean_range.push(-1),n.summaries[t].median.push(0),n.summaries[t].q1.push(0),n.summaries[t].min.push(1/0)}Object.seal(n.order[t]),Object.seal(n.selected_order[t]),Object.seal(n.selected_summaries[t]),Object.seal(n.summaries[t])}}))},calculate_summary:async function(e,t,a){const s=this.settings.dataviews[t],i=s.get.dataset();await this.data_processed[i];const n=i+e;this.inited_summary[n]||this.init_summary(e,i),this.inited_summary[n]=new Promise((e=>{this.summary_ready[n]=e}));const r=this.variables[e],o=r[t];if(s.state||(s.state=s.value()),o.state[i]!==s.state){const m=s.selection[this.settings.settings.summary_selection],h=s.selection.all,u=o.order[i],d=o.selected_order[i],c=o.selected_summaries[i],f=o.summaries[i],_=r.time_range[i][2],p=r.info[i].order,g=r.levels_ids,v=s.n_selected[this.settings.settings.summary_selection]!==s.n_selected.dataset;for(let e=_;e--;)u[e]=v?[]:p[e],d[e]=v?[]:p[e],c.missing[e]=0,c.n[e]=0,f.missing[e]=0,f.n[e]=0,g?(f.mode[e]="",Object.keys(g).forEach((t=>o.table[t][e]=0))):(f.sum[e]=0,f.mean[e]=0,f.max[e]=-1/0,f.min[e]=1/0,f.break_mean[e]=-1,f.break_median[e]=-1);if(p.forEach(((s,i)=>{const n=u[i],r=d[i];var l=0;s.forEach((s=>{const d=s[0],_=s[1];if(d in m){const p=m[d][t],b=g?_ in g:!isNaN(_);i||(e in p.summary||(p.summary[e]={n:0,overall:f,order:u}),p.summary[e].n=0),a&&v&&(n.push(s),d in h&&(r.push(s),b?c.n[i]++:c.missing[i]++)),b?(p.subset_rank[e][i]=l++,p.summary[e].n++,f.n[i]++,g?o.table[_][i]++:(f.sum[i]+=_,_>f.max[i]&&(f.max[i]=_),_<f.min[i]&&(f.min[i]=_))):f.missing[i]++}}))})),a)u.forEach(((e,t)=>{if(g)f.n[t]?(l=0,Object.keys(o.table).forEach((e=>{o.table[e][t]>o.table[r.levels[l]][t]&&(l=g[e])})),f.mode[t]=r.levels[l]):f.mode[t]=NaN;else{if(f.n[t]){f.mean[t]=f.sum[t]/f.n[t],isFinite(f.min[t])||(f.min[t]=f.mean[t]),isFinite(f.max[t])||(f.max[t]=f.mean[t]),f.range[t]=f.max[t]-f.min[t],1===f.n[t]?f.q3[t]=f.median[t]=f.q1[t]=null==e[0][1]?f.mean[t]:e[0][1]:(f.median[t]=quantile(.5,f.n[t],f.missing[t],e),f.q3[t]=quantile(.75,f.n[t],f.missing[t],e),f.q1[t]=quantile(.25,f.n[t],f.missing[t],e));const a=e.length;for(let s=f.missing[t],i=!1,n=!1;s<a&&(!i&&e[s][1]>f.median[t]&&(f.break_median[t]=s-1,i=!0),!n&&e[s][1]>f.mean[t]&&(f.break_mean[t]=s-1,n=!0),!i||!n);s++);}else f.max[t]=0,f.q3[t]=0,f.median[t]=0,f.q1[t]=0,f.min[t]=0;f.n[t]&&(f.norm_median[t]=f.range[t]?(f.median[t]-f.min[t])/f.range[t]:f.median[t],-1!==f.break_median[t]&&(f.lower_median_min[t]=f.norm_median[t]-(e[f.missing[t]][1]-f.min[t])/f.range[t],f.lower_median_range[t]=f.norm_median[t]-((e[f.break_median[t]][1]-f.min[t])/f.range[t]-f.lower_median_min[t]),f.upper_median_min[t]=f.norm_median[t]-(e[f.break_median[t]][1]-f.min[t])/f.range[t],f.upper_median_range[t]=(e[e.length-1][1]-f.min[t])/f.range[t]-f.norm_median[t]-f.upper_median_min[t]),f.norm_mean[t]=f.range[t]?(f.mean[t]-f.min[t])/f.range[t]:f.mean[t],-1!==f.break_mean[t]&&(f.lower_mean_min[t]=f.norm_mean[t]-(e[f.missing[t]][1]-f.min[t])/f.range[t],f.lower_mean_range[t]=f.norm_mean[t]-((e[f.break_mean[t]][1]-f.min[t])/f.range[t]-f.lower_mean_min[t]),f.upper_mean_min[t]=f.norm_mean[t]-(e[f.break_mean[t]][1]-f.min[t])/f.range[t],f.upper_mean_range[t]=(e[e.length-1][1]-f.min[t])/f.range[t]-f.norm_mean[t]-f.upper_mean_min[t]))}}));else for(let e=0;e<_;e++)f.n[e]?g?(q1=0,o.table.forEach((t=>{o.table[t][e]>o.table[r.levels[q1]][e]&&(q1=g[t])})),f.mode[e]=r.levels[q1]):f.mean[e]=f.sum[e]/f.n[e]:f[g?"mode":"mean"][e]=NaN;f.filled=!0,o.state[i]=s.state,this.summary_ready[n]()}else await this.summary_ready[n]},map_variables:function(){Object.keys(this.info).forEach((e=>{this.data_queue[e]={};const t=this.info[e];t.id_vars=t.ids.map((e=>e.variable)),t.schema.fields.forEach((t=>{const a=t.name;if(a in this.variables){const s=this.variables[a];s.datasets.push(e),s.info[e]=t,"string"===t.type&&t.table.forEach((e=>{e in s.levels_ids||(s.levels_ids[e]=s.levels.length,s.levels.push(e))}))}else{const s=this.variables[a]={datasets:[e],info:{},time_range:{},type:t.type};s.info[e]=t,"string"===t.type&&(s.levels=[],s.levels_ids={},t.table.forEach((e=>{s.levels_ids[e]=s.levels.length,s.levels.push(e)}))),s.meta=s.info[e].info,s.meta||(s.meta={full_name:a,measure:a.split(":")[1],short_name:this.format_label(a),type:"integer"}),s.meta.full_name=a,"measure"in s.meta||(s.meta.measure=a.split(":")[1]||a),"short_name"in s.meta||(s.meta.short_name=this.format_label(a)),"long_name"in s.meta||(s.meta.long_name=s.meta.short_name),a in this.variable_info||(this.variable_info[a]=s.meta)}}))}))},map_entities:async function(e){const t=this.in_browser?Object.keys(site.dataviews):["default_view"];if(e in this.sets&&!this.inited[e]){const a=this.sets[e],s=this.meta.times[e],i=this.retrievers[s.is_single?"single":"multi"];Object.keys(a).forEach((n=>{const r=a[n];if("_meta"!==n){const a=this.data_maps[e][n],o=a||{id:n,name:n};o.id=n,"district"in o&&n.length>4&&(o.county=n.substring(0,5)),n in this.entities?(this.entities[n].group=e,this.entities[n].data=r,this.entities[n].variables=this.variables,"features"in this.entities[n]||(this.entities[n].features={})):this.entities[n]={group:e,data:r,variables:this.variables,features:o},Object.keys(o).forEach((e=>{e in this.features||(this.features[e]=this.format_label(e)),"id"!==e&&!a&&e in this.entities[n].features||(this.entities[n].features[e]=o[e])}));const m=this.entities[n];t.forEach((e=>{e in m||(m[e]={summary:{},rank:{},subset_rank:{}})})),m.time=s,m.get_value=i.bind(m)}})),this.inited[e]=!0,this.data_promise[e](),setTimeout((()=>{this.inited.first||(this.hooks.init&&this.hooks.init(),this.inited.first=!0),e in this.data_queue&&Object.keys(this.data_queue[e]).forEach((t=>{this.data_queue[e][t](),delete this.data_queue[e][t]})),this.hooks.onload&&this.hooks.onload()}),0)}for(const e in this.info)if(Object.prototype.hasOwnProperty.call(this.info,e)&&!this.inited[e])return;this.all_data_ready()},parse_query:function(e){const t=JSON.parse(JSON.stringify(export_defaults));if("string"==typeof e){"?"===e[0]&&(e=e.substring(1));const t=e.split("&");e={},t.forEach((t=>{const a=t.split("=");e[a[0]]=a.length>1?a[1]:""}))}return e&&Object.keys(e).forEach((a=>{if("include"===a||"exclude"===a||a in t)t[a]=e[a];else{let s=[];patterns.single_operator.test(a)&&(s=a.replace(patterns.single_operator,"$1=$2").split("="),s.length>1&&(a=s[0],e[a]=s[1]));const i=patterns.component.exec(a),n={name:a.replace(patterns.greater,">").replace(patterns.less,"<"),component:"mean",operator:"=",value:patterns.number.test(e[a])?Number(e[a]):e[a]};if("object"==typeof e[a]&&("component"in e[a]&&(n.component=e[a].component),"operator"in e[a]&&(n.operator=e[a].operator),"value"in e[a]&&(n.value=e[a].value)),a=n.name,i)if(-1!==export_options.filter_components.indexOf(i[2]))n.component=i[2],n.name=i[1];else if(patterns.number.test(i[2])){const e=Number(i[2]),t=e>0&&e<this.meta.overall.value.length?e:this.meta.overall.value.indexOf(e);-1!==t&&(n.time_component=!0,n.component=t,n.name=i[1])}if(patterns.operator_start.test(a)&&a[a.length-1]in this.checks&&(n.operator=a[a.length-1],"<"!==n.operator&&">"!==n.operator||s.length||(n.operator+="="),a===n.name&&(n.name=a.substring(0,a.length-1))),void 0===n.value||"-1"==n.value)return;if("="!==n.operator&&"!"!==n.operator||!patterns.comma.test(n.value)||(n.value=n.value.split(","),n.operator="="===n.operator?"includes":"excludes"),"time_range"===n.name){if("object"==typeof n.value)t.time_range=[this.meta.overall.value.indexOf(Number(n.value[0])),this.meta.overall.value.indexOf(Number(n.value[1]))];else{const e=this.meta.overall.value.indexOf(Number(n.value));t.time_range="="===n.operator?[e,e]:">"===n.operator?[e,this.meta.overall.value.length-1]:[0,e]}-1===t.time_range[0]&&(t.time_range[0]=0),-1===t.time_range[1]&&(t.time_range[1]=this.meta.overall.value.length?this.meta.overall.value.length-1:0)}else"dataset"===n.name?t.dataset=n:n.name in this.features?("id"===n.name&&(n.value=Array.isArray(n.value)?n.value:String(n.value).split(",")),n.check=group_checks[n.operator].bind(n.value),t.feature_conditions.push(n)):n.name in this.variables&&(n.check=(n.time_component?function(e,t){const a="number"!=typeof e,s=this.condition.component-t;return a?this.check(e[s],this.condition.value):!s&&this.check(e,this.condition.value)}:function(e){return this.check(e[this.condition.component],this.condition.value)}).bind({check:this.checks[n.operator],condition:n}),-1===t.variables.filter_by.indexOf(n.name)&&t.variables.filter_by.push(n.name),t.variables.conditions.push(n))}})),"time_range"in t||(t.time_range=[0,this.meta.overall.value.length?this.meta.overall.value.length-1:0]),t},export:async function(e,t,a){a||await this.data_ready,e=this.parse_query(e),t=t||this.entities,-1===export_options.file_format.indexOf(e.file_format)&&(e.file_format=export_defaults.file_format),e.table_format in row_writers||(e.table_format=export_defaults.table_format);const s={statusCode:400,headers:{"Content-Type":"text/plain; charset=utf-8"},body:"Invalid Request"},i=e.include&&e.include.length?"string"==typeof e.include?e.include.split(","):e.include:Object.keys(this.variables),n=e.exclude||[],r=[],o=e.features||JSON.parse(JSON.stringify(export_defaults.features)),m=[],l=[1/0,-1/0],h="csv"===e.file_format?",":"\t",u=row_writers[e.table_format].bind(this),d=!e.variables.filter_by.length,c=!e.feature_conditions.length,f="dataset"in e?group_checks[e.dataset.operator].bind(e.dataset.value):void 0;i.forEach((e=>{e in this.features&&!(e in o)&&(o[e]=this.format_label(e))}));for(const t in this.export_checks)if(t in e){const a=this.export_checks[t]("include"===t?i:e[t],this.variables);if(a)return s.body="Failed check for "+t+": "+a,s}if(Object.keys(this.variable_codes).forEach((e=>{if(-1!==i.indexOf(this.variable_codes[e].name)&&-1===n.indexOf(this.variable_codes[e].name)){r.push(this.variable_codes[e].name);const t=this.meta.ranges[this.variable_codes[e].name];t[0]<l[0]&&(l[0]=t[0]),t[1]>l[1]&&(l[1]=t[1])}})),e.time_range[0]<l[0]&&(e.time_range[0]=l[0]),e.time_range[1]>l[1]&&(e.time_range[1]=l[1]),m.push(Object.keys(o).join(h)),"wide"===e.table_format?r.forEach((t=>{const a=this.meta.ranges[t],s=Math.min(e.time_range[1],a[1])+1;for(let i=Math.max(e.time_range[0],a[0]);i<s;i++)m[0]+=h+t+"_"+this.meta.overall.value[i]})):m[0]+=h+"time"+h+("mixed"===e.table_format?r:["variable","value"]).join(h),Object.keys(t).forEach((a=>{const s=t[a];if((!f||f(s.group))&&(c||passes_feature_filter(t,a,e.feature_conditions))&&(d||passes_filter(s,e.time_range,e.variables,this.variables))){const t=u(s,e.time_range,o,r,h);t&&m.push(t)}})),s.headers["Content-Type"]="text/"+(","===h?"csv":"plain")+"; charset=utf-8",s.body=m.join("\n"),!a)return s.statusCode=200,s.headers["Content-Disposition"]="attachment; filename=data_export."+e.file_format,s;{const t=document.createElement("a");document.body.appendChild(t),t.rel="noreferrer",t.target="_blank",t.download="data_export."+e.file_format,t.href=URL.createObjectURL(new Blob([s.body],{type:s.headers["Content-Type"]})),setTimeout((function(){t.dispatchEvent(new MouseEvent("click")),URL.revokeObjectURL.bind(null,t.href),document.body.removeChild(t)}),0)}}},"undefined"!=typeof module&&(module.exports=DataHandler);